---
- name: Generating os inventory
  template:
    mode: '0755'
    src: templates/os.yml.j2
    dest: "./inventory/os.yml"

- name: Generating vault
  template:
    mode: '0755'
    src: templates/vault.yml.j2
    dest: "./inventory/vault.yml"

- name: Encrypt vault
  ansible.builtin.shell: ansible-vault encrypt "{{ lookup('env', 'PWD') }}"/inventory/vault.yml
  environment: 
    ANSIBLE_VAULT_PASSWORD: "{{ warhorse.general.vault_key }}"
    ANSIBLE_VAULT_PASSWORD_FILE: "./vault-env"

- name: Generating dns inventory
  template:
    mode: '0755'
    src: templates/dns.yml.j2
    dest: "./inventory/dns.yml"

- name: Generating firewall inventory
  template:
    mode: '0755'
    src: templates/firewall.yml.j2
    dest: "./inventory/firewall.yml"
  with_items: "{{ warhorse.vm }}"
  when: item.firewall.enabled

- name: Generating cobaltstrike inventory
  template:
    mode: '0755'
    src: templates/cobaltstrike.yml.j2
    dest: "./inventory/cobaltstrike.yml"
  with_items: "{{ warhorse.vm }}"
  when: item.cobaltstrike is defined

- name: Generating gophish inventory
  template:
    mode: '0755'
    src: templates/gophish.yml.j2
    dest: "./inventory/gophish.yml"
  with_items: "{{ warhorse.vm }}"
  when: item.gophish is defined

- name: Generating mythic inventory
  template:
    mode: '0755'
    src: templates/mythic.yml.j2
    dest: "./inventory/mythic.yml"

- name: Generating traefik inventory
  template:
    mode: '0755'
    src: templates/traefik.yml.j2
    dest: "./inventory/traefik.yml"
  with_items: "{{ warhorse.vm }}"
  when: item.http_proxy == "traefik"

- name: Generating neo4j inventory
  template:
    mode: '0755'
    src: templates/neo4j.yml.j2
    dest: "./inventory/neo4j.yml"
  with_items: "{{ warhorse.vm }}"
  when: item.neo4j is defined

- name: Generating evilginx2 inventory
  template:
    mode: '0755'
    src: templates/evilginx2.yml.j2
    dest: "./inventory/evilginx2.yml"
  with_items: "{{ warhorse.vm }}"
  when: item.evilginx2 is defined

- name: Generating tailscale inventory
  template:
    mode: '0755'
    src: templates/tailscale.yml.j2
    dest: "./inventory/tailscale.yml"
  with_items: "{{ warhorse.vm }}"
  when: item.tailscale is defined

- name: Generating nginx inventory
  template:
    mode: '0755'
    src: templates/nginx.yml.j2
    dest: "./inventory/nginx.yml"
  with_items: "{{ warhorse.vm }}"
  when: item.http_proxy == "nginx"