{% for vm in warhorse.vm %}
{% if loop.first %}
<configuration>
    <system.webServer>
        <rewrite>
            <rules>
                <rule name="redirect get requests URI1" stopProcessing="true">
                    <match url="^(.*)$" />
                    <conditions>
                        <add input="{HTTP_USER_AGENT}" pattern="^(.*)$" />
{% for redirector in vm.cobaltstrike.redirector %}
{% if redirector.auth_header_name is defined %}
                        <add input="{% raw %}{{% endraw %}{{ redirector.auth_header_name }}{% raw %}}{% endraw %}" pattern="{{ redirector.auth_header_value }}" />
{% endif %}
{% endfor %}
                    </conditions>
                    <action type="Rewrite" url="https://{{ vm.name }}.{{ warhorse.dns.op_domain_name }}/{R:0}" appendQueryString="true" logRewrittenUrl="false" />
                </rule>
            </rules>
        </rewrite>
    </system.webServer>
</configuration>
{% endif %}
{% endfor %}