{% for vm in warhorse.vm %}
{% if vm.cobaltstrike.cdn is defined %}
{% for cdn in vm.cobaltstrike.cdn|selectattr("provider", "equalto", "aws" ) %}
{% if vm.cobaltstrike.auth_header_name is defined and vm.cobaltstrike.auth_header_value is defined %}
function handler(event) {
    var request = event.request;
    var headers = request.headers;
    var headerValue = '{{ vm.cobaltstrike.auth_header_value }}'
    var newurl = '{{ cdn.redirect_domain |default('https://aws.com') }}'
  
    if (headers['{{ vm.cobaltstrike.auth_header_name }}']) {
        var authHeader = headers['{{ vm.cobaltstrike.auth_header_name }}'].value;
        if (authHeader === headerValue ) {
            return request;
        } 
    } else {
        var response = {
                statusCode: 302,
            statusDescription: 'Found',
                headers:
                { "location": { "value": newurl } }
        }
        return response;
    }
}
{% endif %}
{% endfor %}
{% endif %}
{% endfor %}